name: Prod Server CD

on:
  workflow_run:
    workflows: [ "Prod Server CI" ]
    types: [ completed ]
    branches: [ main ]

jobs:
  deploy:
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'push'
    runs-on: ubuntu-latest

    permissions:
      actions: read

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: build-artifact
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract deploy tag
        run: |
          echo "DEPLOY_TAG=$(cat image-tag.txt)" >> $GITHUB_ENV
          echo "Deploying version: $(cat image-tag.txt)"

      - name: Deploy to EC2 instance via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROD_EC2_HOST }}
          username: ${{ secrets.PROD_EC2_USERNAME }}
          key: ${{ secrets.PROD_EC2_SSH_KEY }}
          script: |
            # Login to Docker Hub
            echo ${{ secrets.DOCKERHUB_PROD_TOKEN }} | sudo docker login -u ${{ secrets.DOCKERHUB_PROD_USERNAME }} --password-stdin

            # Stop and remove existing container
            if [ "$(sudo docker ps -a -q -f name=moment-app-server)" ]; then
              sudo docker stop moment-app-server
              sudo docker rm -f moment-app-server
            fi
            
            # Pull latest image
            sudo docker pull ${{ secrets.DOCKERHUB_PROD_USERNAME }}/moment-prod-images:${{ env.DEPLOY_TAG }}
            
            # Deploy with Docker Compose
            cd /home/ubuntu/moment
            export IMAGE_TAG=${{ env.DEPLOY_TAG }}
            
            echo "Deploying with image tag: $IMAGE_TAG"
            sudo -E docker compose up --no-deps -d app
            
            # Prune old images
            sudo docker image prune -f