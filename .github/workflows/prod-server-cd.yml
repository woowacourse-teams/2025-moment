name: Prod Server CD

on:
  workflow_run:
    workflows: [ "Prod Server CI" ]
    types: [ completed ]
    branches: [ main ]

jobs:
  deploy:
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'push'
    runs-on: ubuntu-latest

    permissions:
      actions: read

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: build-artifact
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract deploy info
        run: |
          cat deploy-info.txt
          source deploy-info.txt
          echo "DEPLOY_API=$DEPLOY_API" >> $GITHUB_ENV
          echo "DEPLOY_ADMIN=$DEPLOY_ADMIN" >> $GITHUB_ENV
          echo "DEPLOY_TAG=$DEPLOY_TAG" >> $GITHUB_ENV

      - name: Deploy to EC2 instance via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROD_EC2_HOST }}
          username: ${{ secrets.PROD_EC2_USERNAME }}
          key: ${{ secrets.PROD_EC2_SSH_KEY }}
          script: |
            echo ${{ secrets.DOCKERHUB_PROD_TOKEN }} | sudo docker login -u ${{ secrets.DOCKERHUB_PROD_USERNAME }} --password-stdin

            cd /home/ubuntu/moment

            # Load current image tags (fallback to 'latest' if file doesn't exist)
            touch .image-tags
            source .image-tags
            export API_IMAGE_TAG=${API_IMAGE_TAG:-latest}
            export ADMIN_IMAGE_TAG=${ADMIN_IMAGE_TAG:-latest}

            # Deploy API if changed
            if [ "${{ env.DEPLOY_API }}" = "true" ]; then
              echo ">>> Deploying API (tag: ${{ env.DEPLOY_TAG }})"
              sudo docker pull ${{ secrets.DOCKERHUB_PROD_USERNAME }}/moment-prod-api:${{ env.DEPLOY_TAG }}
              export API_IMAGE_TAG=${{ env.DEPLOY_TAG }}
              if [ "$(sudo docker ps -a -q -f name=moment-api-server)" ]; then
                sudo docker stop moment-api-server
                sudo docker rm -f moment-api-server
              fi
              sudo -E docker compose up --no-deps -d api
            fi

            # Deploy Admin if changed
            if [ "${{ env.DEPLOY_ADMIN }}" = "true" ]; then
              echo ">>> Deploying Admin (tag: ${{ env.DEPLOY_TAG }})"
              sudo docker pull ${{ secrets.DOCKERHUB_PROD_USERNAME }}/moment-prod-admin:${{ env.DEPLOY_TAG }}
              export ADMIN_IMAGE_TAG=${{ env.DEPLOY_TAG }}
              if [ "$(sudo docker ps -a -q -f name=moment-admin-server)" ]; then
                sudo docker stop moment-admin-server
                sudo docker rm -f moment-admin-server
              fi
              sudo -E docker compose up --no-deps -d admin
            fi

            # Save current image tags
            cat > .image-tags << EOF
            API_IMAGE_TAG=$API_IMAGE_TAG
            ADMIN_IMAGE_TAG=$ADMIN_IMAGE_TAG
            EOF

            sudo docker image prune -f
