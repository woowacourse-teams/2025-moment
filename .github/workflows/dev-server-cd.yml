name: Deploy to EC2

on:
  push:
    branches: [ develop ]
    paths: [ 'server/**' ]  # server ë””ë ‰í† ë¦¬ ë³€ê²½ ì‹œì—ë§Œ ë°°í¬

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: EC2ì— ë°°í¬ íŒŒì¼ ì „ì†¡ ë° ë°°í¬
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_PRIVATE_KEY }}
          port: ${{ secrets.EC2_SSH_PORT }}
          script: |
          # Git ì €ì¥ì†Œ ì—…ë°ì´íŠ¸
            git fetch origin
            git checkout develop
            git pull origin develop
            
            # server ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            cd server
            
            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬
            echo "ğŸ”„ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬ ì¤‘..."
            docker compose down --remove-orphans
            
            # ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€ ì •ë¦¬
            docker system prune -f
            
            # ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
            echo "ğŸš€ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì¤‘..."
            chmod +x deploy.sh
            ./deploy.sh
            
            # í—¬ìŠ¤ì²´í¬ ëŒ€ê¸° (DB ì¤€ë¹„ë  ë•Œê¹Œì§€)
            echo "ğŸ¥ í—¬ìŠ¤ì²´í¬ ëŒ€ê¸° ì¤‘..."
            sleep 20
            
            # ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œê·¸ í™•ì¸
            echo "ğŸ“‹ ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œê·¸:"
            docker compose logs --tail=50 app
