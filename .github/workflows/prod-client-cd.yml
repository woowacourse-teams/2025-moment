name: Notify PR Open or Merge to Discord (client only)

on:
  pull_request:
    types:
      - opened
      - closed

jobs:
  notify-discord:
    runs-on: ubuntu-latest
    steps:
      - name: Notify Discord about PR (opened or merged)
        uses: actions/github-script@v7
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_FE }}
        with:
          script: |
            const webhookUrl = process.env.DISCORD_WEBHOOK_FE;
            if (!webhookUrl) {
              console.log('Discord webhook URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
              return;
            }

            const pr = context.payload.pull_request;
            const action = context.payload.action;

            if (!['opened', 'closed'].includes(action)) {
              console.log(`ì²˜ë¦¬í•˜ì§€ ì•ŠëŠ” PR ì´ë²¤íŠ¸: ${action}`);
              return;
            }

            if (action === 'closed' && !pr.merged) {
              console.log('PRì´ ë‹«í˜”ì§€ë§Œ ë³‘í•©ë˜ì§€ ì•ŠìŒ. ì•Œë¦¼ ìƒëµ');
              return;
            }

            const files = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
              per_page: 100,
            });

            const changedInClient = files.data.some(file => file.filename.startsWith('client/'));
            if (!changedInClient) {
              console.log('client ë””ë ‰í† ë¦¬ì— ë³€ê²½ì‚¬í•­ ì—†ìŒ. ì•Œë¦¼ ìƒëµ');
              return;
            }

            const embed = {
              title: action === 'opened'
                ? `ğŸ“¥ PR Opened: ${pr.title}`
                : `ğŸ”€ PR Merged: ${pr.title}`,
              description: action === 'opened'
                ? `**client** ë””ë ‰í† ë¦¬ì— ë³€ê²½ì‚¬í•­ì´ ìˆëŠ” PRì´ ì—´ë ¸ìŠµë‹ˆë‹¤.\n\n**ì‘ì„±ì:** [@${pr.user.login}](${pr.user.html_url})\n**PR ë§í¬:** [#${pr.number}](${pr.html_url})`
                : `**client** ë””ë ‰í† ë¦¬ ë³€ê²½ì´ í¬í•¨ëœ PRì´ ë³‘í•©ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰\n\n**ì‘ì„±ì:** [@${pr.user.login}](${pr.user.html_url})\n**PR ë§í¬:** [#${pr.number}](${pr.html_url})`,
              color: action === 'opened' ? 0x00b0f4 : 0x5865F2,
              author: {
                name: pr.user.login,
                icon_url: pr.user.avatar_url
              },
              timestamp: new Date().toISOString(),
              fields: [
                { name: "ê¸°ë°˜ ë¸Œëœì¹˜", value: `${pr.base.ref}`, inline: true },
                { name: "PR ë¸Œëœì¹˜", value: `${pr.head.ref}`, inline: true },
                ...(action === 'closed'
                  ? [{ name: "ì»¤ë°‹ ìˆ˜", value: `${pr.commits}`, inline: true }]
                  : [])
              ]
            };

            const discordPayload = { embeds: [embed] };

            const response = await fetch(webhookUrl, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(discordPayload)
            });

            if (!response.ok) {
              const responseBody = await response.text();
              console.error(`Discord ì „ì†¡ ì‹¤íŒ¨: ${response.status} ${response.statusText}`);
              console.error(`ì‘ë‹µ ë‚´ìš©: ${responseBody}`);
              core.setFailed(`ë””ìŠ¤ì½”ë“œ ì „ì†¡ ì‹¤íŒ¨`);
            } else {
              console.log(`ë””ìŠ¤ì½”ë“œ ì•Œë¦¼ ì „ì†¡ ì„±ê³µ (${action})`);
            }
