name: Notify PR Merge to Discord (moment-client only)

on:
  pull_request:
    types:
      - closed

jobs:
  notify-discord:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Notify Discord about PR Merge (main/develop only, client only)
        uses: actions/github-script@v7
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        with:
          script: |
            const webhookUrl = process.env.DISCORD_WEBHOOK;
            if (!webhookUrl) {
              console.log('Discord webhook URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
              return;
            }

            const pr = context.payload.pull_request;

            // ë³‘í•© ë¸Œëœì¹˜ê°€ main ë˜ëŠ” developì¼ ê²½ìš°ë§Œ
            const targetBranches = ['main', 'develop'];
            if (!targetBranches.includes(pr.base.ref)) {
              console.log(`ë³‘í•© ëŒ€ìƒ ë¸Œëœì¹˜ '${pr.base.ref}'ì€ ì œì™¸ë¨`);
              return;
            }

            // ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ ì¡°íšŒ
            const files = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
              per_page: 100,
            });

            const changedInClient = files.data.some(file => file.filename.startsWith('client/'));
            if (!changedInClient) {
              console.log('client ë””ë ‰í† ë¦¬ì— ë³€ê²½ì‚¬í•­ ì—†ìŒ. ì•Œë¦¼ ìƒëµ');
              return;
            }

            // ì•Œë¦¼ Embed ìƒì„±
            const embed = {
              title: `ğŸ”€ PR Merged: ${pr.title}`,
              description: `ğŸ§© **client** ë””ë ‰í† ë¦¬ ë³€ê²½ì´ í¬í•¨ëœ PRì´ ë³‘í•©ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰\n\n**ì‘ì„±ì:** [@${pr.user.login}](${pr.user.html_url})\n**PR ë§í¬:** [#${pr.number}](${pr.html_url})`,
              color: 0x5865F2, // ë””ìŠ¤ì½”ë“œ ë¸”ë£¨
              author: {
                name: pr.user.login,
                icon_url: pr.user.avatar_url
              },
              timestamp: new Date().toISOString(),
              fields: [
                { name: "ë³‘í•© ë¸Œëœì¹˜", value: `${pr.base.ref}`, inline: true },
                { name: "HEAD ë¸Œëœì¹˜", value: `${pr.head.ref}`, inline: true },
                { name: "ì»¤ë°‹ ìˆ˜", value: `${pr.commits}`, inline: true }
              ]
            };

            const discordPayload = {
              embeds: [embed]
            };

            const response = await fetch(webhookUrl, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(discordPayload)
            });

            if (!response.ok) {
              console.error(`Error sending to Discord: ${response.status} ${response.statusText}`);
              const responseBody = await response.text();
              console.error(`Response body: ${responseBody}`);
              core.setFailed(`ë””ìŠ¤ì½”ë“œ ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨: ${response.status}`);
            } else {
              console.log('PR ë³‘í•© ì•Œë¦¼ ë””ìŠ¤ì½”ë“œ ì „ì†¡ ì„±ê³µ');
            }
